cjModules.define(function(){"use strict";return function(e,n){function a(){return cjBasics.resources.loadScript("scripts/moment+langs.min.js").then(function(){moment.lang("relative-formatter",{relativeTime:{future:"%s",past:"%s",s:"1s",ss:"%ds",m:"1m",mm:"%dm",h:"1h",hh:"%dh",d:"1d",dd:"%dd",M:"1mo",MM:"%dmo",y:"1yr",yy:"%dy"}})})}function t(){z=mdElements.createElement("container",{solid:!0}),z.hidden=!0,z.classList.add("bm-p-calendargapi-newevent"),bmElements.setLoading(z,!0);var a=cjBasics.urlParams.attach(N+"/day",{bm_cid:"calendargapi-newevent",bm_wiz:n.sid,bm_xfo:n.sid,hl:cjBasics.lang.current});G=bmElements.createElement("iframe",{src:a,shadow:!0,onMessage:function(e){var n=e.bm_method;"calendargapiNeweventClose"===n&&(z.hidden=!0,$&&v())},onLoad:function(){bmElements.setLoading(z,!1)}});var t=bmElements.createElement("ogb",{displayBack:!0,bmApis:n,serviceLabel:cjBasics.lang.i18n("cj_i18n_00302","Calendar"),pageLabel:cjBasics.lang.i18n("cj_i18n_00268","New event"),onBack:function(){$=!1,G.cjceSendFrameCommand({method:"calendargapiNeweventCancel"},S)}});z.appendChild(t);var i=mdElements.createElement("button",{label:cjBasics.lang.i18n("cj_i18n_01363","Save"),fill:!0,color:!0,onClick:function(){$=!0,G.cjceSendFrameCommand({method:"calendargapiNeweventSave"},S)}});t.cjceAppendChild(i),z.appendChild(G),e.appendChild(z)}function i(){z.hidden=!1,G.cjceSendFrameCommand({method:"calendargapiNeweventActivate"},S)}function c(a){if("not_authorized"===a.cjg_error&&!V){V=!0,F&&(F.remove(),F.textContent="",F=null),cjgApis.cache.remove(n.account,"bm_cache_v05__calendar__events");var t=mdElements.createElement("container",{darkMode:n.darkMode,shadow:"thin"}),i=cjBasics.lang.i18n("cj_i18n_00291","Home");O.cjceSetPageLabel(i),Z.hidden=!1,J.hidden=!0,q.hidden=!0,Z.classList.remove("bm-p-calendargapi-searchbox");var c=bmElements.createElement("fulldialog",{inline:!0,darkMode:n.darkMode,lockup:{label:cjBasics.lang.i18n("cj_i18n_00302","Calendar")},iconName:"calendar",message:cjBasics.lang.i18n("cj_i18n_00264","Before you can use this page, you need to give access to load your Google Calendar Data"),actionLabel:cjBasics.lang.i18n("cj_i18n_01178","Continue"),action:function(){cjgApis.auth.requestPermissions(n.account,a.cjg_missing_scopes)}});t.appendChild(c),e.appendChild(t)}return Promise.reject(a)}function r(e,a){a=a||{},a.prettyPrint="false";var t=cjBasics.urlParams.attach(B+e,a);return cjgApis.request(t,{fetchAs:"json"},{account:n.account,requiredScopes:k})["catch"](c)}function s(){return browserStorage.sync.getItem("bm_pref__calendar__hidereminders").then(function(e){P=!e})}function o(){var e=r("users/me/settings/format24HourTime",{fields:"value"}).then(function(e){var a=JSON.parse(e.value);return cjgApis.cache.setItem(n.account,"bm_cache_v05__calendar__24hours",a),a});return cjgApis.cache.getItem(n.account,"bm_cache_v05__calendar__24hours").then(function(n){return"boolean"==typeof n?n:e})}function d(e,a){var t=B+"users/me/calendarList/"+encodeURIComponent(e);return cjgApis.request(t,{method:"patch",body:JSON.stringify({selected:a}),headers:{"Content-Type":"application/json"}},{account:n.account,requiredScopes:k})["catch"](c)}function l(){return r("users/me/calendarList",{maxResults:"250",fields:"items(backgroundColor,foregroundColor,id,selected,summary,colorId)"}).then(function(e){return e.items||[]})}function m(e){return e?"string"==typeof e?moment(e.replace("Z","+00:00"),["YYYY-MM-DDTHH:mm:ssZZ","YYYY-MM-DDTHHmmssZZ","YYYYMMDDTHHmmssZZ","YYYY-MM-DDTHH:mm:ss","YYYY-MM-DDTHHmmss","YYYYMMDDTHHmmss","YYYY-MM-DDTHH:mmZZ","YYYY-MM-DDTHHmmZZ","YYYYMMDDTHHmmZZ","YYYY-MM-DDTHH:mm","YYYY-MM-DDTHHmm","YYYYMMDDTHHmm","YYYY-MM-DDTHH","YYYYMMDDTHH","YYYY-MM-DD","YYYYMMDD"]):moment(e):null}function u(e,n){if(e.allday!==n.allday)return e.allday?-1:1;if(e.start!==n.start)return e.start-n.start;if(e.isReminder!==n.isReminder)return e.isReminder?-1:1;var a=(e.title||"").toLowerCase(),t=(n.title||"").toLowerCase();return a!==t?a<t?-1:1:e.calendarUrl<n.calendarUrl?-1:1}function p(e){return e.colorId?{foreground:"#fff",background:ae[Number(e.colorId)-1]}:{foreground:e.foregroundColor||"#fff",background:e.backgroundColor||T}}function g(e){var a=moment().add("days",K),t=e?"H:mm":"h:mma";return cjgApis.request("https://www.googleapis.com/reminders/v1internal/reminders/list?fields=*",{method:"POST",fetchAs:"json",headers:{"Content-Type":"application/json"},body:JSON.stringify({includeDeleted:!1,includeArchived:!1,dueBeforeMs:a.valueOf().toString()})},{internal:!0,account:n.account,requiredScopes:k}).then(function(e){return"object"==typeof e&&Array.isArray(e.task)?e.task:[]},function(){return[]}).then(function(e){return e.filter(function(e){return e&&e.dueDate&&e.dueDate.year}).map(function(e){var a=e||{},i=a.dueDate||{},c=new Date;c.setFullYear(i.year),c.setMonth(i.month-1),c.setDate(i.day),i.time&&(c.setHours(i.time.hour),c.setMinutes(i.time.minute),c.setSeconds(i.time.second));var r=c.toISOString(),s=m(r),o=s.valueOf(),d=!1;return a.externalApplicationLink&&"keepReminder"===a.externalApplicationLink.application&&(d="https://keep.google.com/"+n.wizPath+"?reminder="+a.externalApplicationLink.id),{isReminder:!0,colorData:w,title:a.title||cjBasics.lang.i18n("cj_i18n_01737","(No title)"),start:o,allday:i.allDay,calendarUrl:d,timeString:s.format(t)}})})["catch"](function(){return[]})}function h(e,n){var a=moment().subtract("days",K),t=moment().add("days",K),i=n?"H:mm":"h:mma",s="calendars/"+encodeURIComponent(e.id)+"/events";return r(s,{timeMin:a.toISOString(),timeMax:t.toISOString(),maxResults:"2500",orderBy:"startTime",singleEvents:"true",fields:"items(end/dateTime,endTimeUnspecified,htmlLink,start(date,dateTime),summary)"}).then(function(n){for(var a=[],t=0;t<n.items.length;t++){var c=n.items[t];if("undefined"!=typeof c.htmlLink){var r=m(c.start.dateTime||c.start.date),s="date"in c.start,o=null;s||(o=r.format(i),c.endTimeUnspecified||(o+=" - "+m(c.end.dateTime).format(i))),a.push({isReminder:!1,colorData:p(e),title:c.summary||cjBasics.lang.i18n("cj_i18n_01737","(No title)"),start:r.valueOf(),allday:s,calendarUrl:c.htmlLink,timeString:o})}}return a},c)}function f(){var e=F.querySelector(".bm-p-calendargapi-datebadge--selected");e&&(F.scrollTop=e.offsetTop-e.offsetHeight-48)}function _(e){F.textContent="";var a=JSON.parse(e);if(0===a.length){var t=mdElements.createElement("emptystate",{color:T,iconName:"__mdi:event",label:cjBasics.lang.i18n("cj_i18n_00265","No events found"),subLabel:cjBasics.lang.i18n("cj_i18n_00266","To add a new event, click the red button in the bottom right corner")});return void F.appendChild(t)}for(var i,c=document.createDocumentFragment(),r=0;r<a.length;r++){var s=a[r],o=s.month;if(0===r||o!==a[r-1].month){i&&c.appendChild(i),i=document.createElement("div"),i.className="bm-p-calendargapi-monthlist",i.dataset.month=o.toString();var d=document.createElement("div");d.className="bm-p-calendargapi-monthlist__header",d.textContent=ne[o],i.appendChild(d)}var l=document.createElement("div");l.className="bm-p-calendargapi-monthlist__item";var m=document.createElement("div");m.className="bm-p-calendargapi-datebadge",l.appendChild(m),s.isToday&&m.classList.add("bm-p-calendargapi-datebadge--selected");var u=document.createElement("div");u.className="bm-p-calendargapi-datebadge__date",u.textContent=s.dayNumber,m.appendChild(u);var p=document.createElement("div");p.className="bm-p-calendargapi-datebadge__weekday",p.textContent=s.dayName,m.appendChild(p);var g=document.createElement("div");if(g.className="bm-p-calendargapi-eventlist",l.appendChild(g),0===s.events.length){var h=document.createElement("div");h.className="bm-p-calendargapi-eventlist__noresults",h.textContent=cjBasics.lang.i18n("cj_i18n_00267","No events today"),g.appendChild(h)}else s.events.forEach(function(e){var a=document.createElement("div");a.classList.add("bm-p-calendargapi-eventlist__item"),a.addEventListener("click",function(){var a=e.calendarUrl.replace("https://www.google.com/calendar/event",N);n.openTab(a)});var t=e.title||cjBasics.lang.i18n("cj_i18n_01737","(No title)"),i=!e.allday;if(e.isReminder){i&&(t+=", "+e.timeString);var c=mdElements.createElement("icon",{theme:"solid",color:"#fff",name:"__mdi:reminders_alt",size:16});c.classList.add("bm-p-calendargapi-eventlist__remindericon"),a.appendChild(c)}else i&&(t+="\n"+e.timeString);a.style.color=e.colorData.foreground,a.style.backgroundColor=e.colorData.background;var r=document.createTextNode(t);a.appendChild(r),g.appendChild(a)});i.appendChild(l)}c.appendChild(i),F.appendChild(c),f()}function b(){var e=[],n=Promise.all([A,H,I]).then(function(e){return P?g(e[1]):[]}).then(function(n){e=e.concat(n)});return Promise.all([L,H,I]).then(function(a){var t=a[0],i=a[1],c=t.map(function(n){return n.selected!==!0?Promise.resolve():h(n,i).then(function(n){n&&(e=e.concat(n))})});return c.push(n),Promise.all(c).then(function(){return e.sort(function(e,n){return e.start-n.start})})})}function v(){return bmElements.setLoading(F,!0),b().then(function(e){var n=moment(),a={},t=n.format("YYYYMMDD");a[t]={isToday:!0,dayId:t,dayName:n.format("ddd"),dayNumber:n.format("D"),month:n.month(),events:[]},e.forEach(function(e){var n=moment(e.start),t=n.format("YYYYMMDD");a[t]||(a[t]={dayId:t,dayName:n.format("ddd"),dayNumber:n.format("D"),month:n.month(),events:[]}),a[t].events.push(e)});var i=Object.keys(a).map(function(e){return a[e].events=a[e].events.sort(u),a[e]}).sort(function(e,n){return e.dayId<n.dayId?-1:1});return JSON.stringify(i)}).then(function(e){return e===x?null:(x=e,cjgApis.cache.setItem(n.account,"bm_cache_v05__calendar__events",e),_(e))}).then(function(){bmElements.setLoading(F,!1),Q=!0})}function j(e){return window.btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function y(e,a){var t=e.colorData||p(e),i=bmElements.createElement("navitem",{theme:"solid",iconName:"__mdi:check_box",color:t.background,colorIcon:!0,label:e.summary,divider:a});if(i.classList.add("bm-p-calendargapi-draweritem"),i.addEventListener("click",function(n){var a,t=i.classList.toggle("bm-p-calendargapi-draweritem--inactive");e.isRemindersCalendar?(P=!t,a=browserStorage.sync.setItem("bm_pref__calendar__hidereminders",t)):a=d(e.id,!t),a.then(v),n.stopPropagation()}),e.selected||i.classList.add("bm-p-calendargapi-draweritem--inactive"),!e.isRemindersCalendar){var c=mdElements.createElement("iconbutton",{iconName:"__mdi:settings",label:cjBasics.lang.i18n("cj_i18n_01254","Settings and sharing"),onClick:function(a){n.openTab(N+"/settings/calendar/"+j(e.id)),a.stopPropagation()}});c.classList.add("bm-p-calendargapi-draweritem__settings"),i.appendChild(c)}return i}function Y(){var e=mdElements.createElement("list");R.appendChild(e),Promise.all([L,A]).then(function(n){n[0].concat({isRemindersCalendar:!0,selected:P,colorData:w,summary:cjBasics.lang.i18n("cj_i18n_00081","Reminders")}).sort(function(e,n){return e.summary<n.summary?-1:1}).forEach(function(a,t){var i=y(a,t===n[0].length);e.appendChild(i)}),e.lastChild.classList.add("cj-md-item--divider")});var a={trash:{iconName:"__mdi:delete",label:cjBasics.lang.i18n("cj_i18n_00005","Trash"),newTabUrl:N+"/trash",external:!0},settings:{iconName:"__mdi:settings",label:cjBasics.lang.i18n("cj_i18n_00298","Settings"),newTabUrl:N+"/settings",external:!0}},t=bmElements.createElement("navlist",{items:a,onNewTab:function(e,a){var t=a.newTabUrl||cjgShortcuts.getUrl(a.shortcutId,n.account);n.openTab(t)},onClick:function(e){"reminders"!==e&&"tasks"!==e||n.pageManager.navigate(e)}});R.appendChild(t)}function C(){return F=mdElements.createElement("container",{darkMode:n.darkMode,scrollable:!0,shadow:"thinOnScroll"}),F.addEventListener("scroll",function(){for(var e=F.querySelectorAll(".bm-p-calendargapi-monthlist"),n=e[0].dataset.month,a=1;a<e.length&&!(F.scrollTop<e[a].offsetTop-68);a++)n=parseInt(e[a].dataset.month,10);O.cjceSetPageLabel(ne[n])}),v(),cjgApis.cache.getItem(n.account,"bm_cache_v05__calendar__events").then(function(e){e&&e.length>0&&!Q&&(x=e,_(e))}),F}function M(e){var a=cjBasics.urlParams.attach(N+"/search",{q:e});n.openTab(a)}function D(e){U.cjceSetCollapseState(e),O.cjceSetBackState(e),Z.hidden=!e,q.hidden=e,J.hidden=e}function E(){A=s(),L=l(),H=o(),I=a(),O=bmElements.createElement("ogb",{darkMode:n.darkMode,drawer:{color:T},serviceIcon:"calendar",serviceLabel:cjBasics.lang.i18n("cj_i18n_00302","Calendar"),pageLabel:ne[X],searchbox:{collapsable:!0,color:T,onSubmit:M,submitInNewTab:!0},bmApis:n,onNewTab:function(){n.openTab(N)},onBack:function(){D(!1)}}),e.appendChild(O),U=O.cjceNavigatorEle,R=O.cjceDrawerEle,Z=O.cjceSearchboxEle,Z.hidden=!0,n.onPageDisplay(Z.select),J=mdElements.createElement("button",{hairline:!0,label:cjBasics.lang.i18n("cj_i18n_01253","Today"),onClick:f}),O.cjceAppendChild(J),q=mdElements.createElement("iconbutton",{iconName:"__mdi:search",onClick:function(){D(!0),Z.select()}}),O.cjceAppendChild(q);var c=C();e.appendChild(c),Y();var r=bmElements.createElement("fab",{darkMode:n.darkMode,label:cjBasics.lang.i18n("cj_i18n_00268","New event"),onClick:function(){ee?z?i():setTimeout(i,500):n.openTab(N+"/eventedit")}});e.appendChild(r),ee&&setTimeout(t,500)}var T="#1a73e8",w={foreground:"#fff",background:"#3f51b5"},k=["https://www.googleapis.com/auth/calendar"],B="https://www.googleapis.com/calendar/v3/",S="https://calendar.google.com",N=S+"/calendar/";"0"!==n.account.authuser&&(N+="b/"+n.account.authuser+"/"),N+="r";var L,H,A,I,x,P,O,R,U,Z,q,J,F,z,G,$,K=31,Q=!1,V=!1,W=new Date,X=W.getMonth(),ee=!cjBasics.navigator.vivaldi,ne=[cjBasics.lang.i18n("cj_i18n_00165","January"),cjBasics.lang.i18n("cj_i18n_00166","February"),cjBasics.lang.i18n("cj_i18n_00167","March"),cjBasics.lang.i18n("cj_i18n_00168","April"),cjBasics.lang.i18n("cj_i18n_00169","May"),cjBasics.lang.i18n("cj_i18n_00170","June"),cjBasics.lang.i18n("cj_i18n_00171","July"),cjBasics.lang.i18n("cj_i18n_00172","August"),cjBasics.lang.i18n("cj_i18n_00173","September"),cjBasics.lang.i18n("cj_i18n_00174","October"),cjBasics.lang.i18n("cj_i18n_00175","November"),cjBasics.lang.i18n("cj_i18n_00176","December")],ae=["#795548","#e67c73","#d50000","#f4511e","#ef6c00","#f09300","#00897B","#0b8043","#7cb342","#c0ca33","#e4c441","#f6bf26","#33b679","#039be5","#4285f4","#3f51b5","#7986cb","#b39ddb","#616161","#a79b8e","#ad1457","#d81b60","#8e24aa","#9e69af"];E()}});